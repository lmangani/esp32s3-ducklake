name: ESP32-S3 CI with QEMU

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  ESP_IDF_VERSION: v5.3.2
  MCU: esp32s3

jobs:
  build:
    name: Build ESP32-S3 Project
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install espup
        uses: esp-rs/espup-action@v1
        with:
          version: latest

      - name: Install Rust ESP toolchain
        uses: esp-rs/rust-build@v1
        with:
          default: true
          toolchain-version: stable
          targets: xtensa-esp32s3-espidf

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache ESP-IDF
        uses: actions/cache@v4
        with:
          path: |
            ~/.espressif/
            ~/.cargo/xtensa-esp32s3-espidf/
          key: ${{ runner.os }}-esp-idf-${{ env.ESP_IDF_VERSION }}
          restore-keys: |
            ${{ runner.os }}-esp-idf-

      - name: Set up build environment
        run: |
          source $HOME/export-esp.sh
          echo "ESP_IDF_VERSION=$ESP_IDF_VERSION" >> $GITHUB_ENV
          echo "IDF_PATH=$IDF_PATH" >> $GITHUB_ENV
          # Verify ESP-IDF is set up correctly
          echo "IDF_PATH: $IDF_PATH"
          echo "RUSTC: $(which rustc)"
          rustc --version
          rustc --print target-list | grep esp || echo "ESP targets not found in rustc"

      - name: Build project (debug)
        run: |
          source $HOME/export-esp.sh
          cargo build --target xtensa-esp32s3-espidf --verbose
        continue-on-error: false

      - name: Build project (release)
        run: |
          source $HOME/export-esp.sh
          cargo build --release --target xtensa-esp32s3-espidf --verbose
        continue-on-error: false

      - name: Verify binary format
        run: |
          source $HOME/export-esp.sh
          if [ -f "target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test" ]; then
            file target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test
            readelf -h target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test | head -20
            echo "✅ Binary format verified"
          else
            echo "❌ Release binary not found"
            exit 1
          fi

      - name: Check binary size
        run: |
          BINARY_SIZE=$(stat -c%s target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test 2>/dev/null || echo "0")
          echo "Binary size: $BINARY_SIZE bytes ($(echo "scale=2; $BINARY_SIZE/1024" | bc) KB)"
          echo "binary_size=$BINARY_SIZE" >> $GITHUB_ENV
          
          # Warn if binary is larger than 3MB (75% of 4MB partition)
          if [ "$BINARY_SIZE" -gt 3145728 ]; then
            echo "⚠️ Warning: Binary size exceeds 3MB (75% of 4MB partition)"
          fi

      - name: Install ESP-IDF tools for binary conversion
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install esptool

      - name: Convert ELF to flashable binary
        run: |
          source $HOME/export-esp.sh
          mkdir -p qemu_images
          if [ -f "target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test" ]; then
            # Try to use esptool if available in PATH, otherwise use pip version
            if command -v esptool.py &> /dev/null; then
              ESPTOOL=esptool.py
            else
              ESPTOOL=esptool
            fi
            
            $ESPTOOL --chip esp32s3 \
              elf2image \
              --flash_mode dio \
              --flash_freq 80m \
              --flash_size 16MB \
              -o qemu_images/esp32s3-parquet-test.bin \
              target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test || \
            echo "⚠️ esptool conversion failed, continuing with ELF binary"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: esp32s3-binary
          path: |
            target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test
            target/xtensa-esp32s3-espidf/debug/esp32s3-parquet-test
            qemu_images/*.bin
          retention-days: 7
          compression-level: 6

  qemu-test:
    name: QEMU Simulation Test
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-binary
          path: ./

      - name: Install ESP-IDF and QEMU dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            python3-pip \
            python3-venv \
            git \
            wget \
            flex \
            bison \
            gperf \
            cmake \
            ninja-build \
            ccache \
            libffi-dev \
            libssl-dev \
            dfu-util \
            libusb-1.0-0

      - name: Set up ESP-IDF for QEMU
        run: |
          # Install ESP-IDF (needed for esptool and QEMU tools)
          git clone --recursive --depth 1 --branch ${{ env.ESP_IDF_VERSION }} \
            https://github.com/espressif/esp-idf.git ~/esp-idf
          cd ~/esp-idf
          ./install.sh esp32s3
          . ./export.sh
          echo "IDF_PATH=$IDF_PATH" >> $GITHUB_ENV

      - name: Install QEMU for ESP32-S3
        run: |
          # Check if QEMU supports ESP32-S3
          # Note: ESP32-S3 QEMU support is experimental
          sudo apt-get install -y qemu-system-xtensa qemu-utils
          qemu-system-xtensa --version || echo "QEMU installed but ESP32-S3 support may be limited"

      - name: Validate binary structure
        run: |
          if [ -f "qemu_images/esp32s3-parquet-test.bin" ]; then
            BIN_SIZE=$(stat -c%s qemu_images/esp32s3-parquet-test.bin)
            echo "Binary size: $BIN_SIZE bytes"
            
            # Check if binary has valid ESP32 header
            hexdump -C qemu_images/esp32s3-parquet-test.bin | head -5
            echo "✅ Binary structure validated"
          elif [ -f "target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test" ]; then
            echo "⚠️ Using ELF binary (conversion may have failed)"
            file target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test
          else
            echo "❌ No binary found"
            exit 1
          fi

      - name: Run QEMU simulation (if supported)
        run: |
          echo "⚠️ Note: ESP32-S3 QEMU support is experimental"
          echo "This step validates binary format and structure"
          echo "For full hardware testing, flash to actual ESP32-S3 hardware"
          
          # Check for binary files
          if [ -f "qemu_images/esp32s3-parquet-test.bin" ]; then
            BIN_FILE="qemu_images/esp32s3-parquet-test.bin"
            echo "✅ Using flashable binary: $BIN_FILE"
          elif [ -f "target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test" ]; then
            BIN_FILE="target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test"
            echo "⚠️ Using ELF binary: $BIN_FILE"
          else
            echo "❌ No binary found for QEMU"
            exit 1
          fi
          
          # Validate binary exists and show info
          file "$BIN_FILE"
          ls -lh "$BIN_FILE"
          
          echo ""
          echo "✅ Binary ready for QEMU simulation"
          echo "Binary location: $BIN_FILE"
          echo ""
          echo "Note: Full QEMU execution requires ESP32-S3 QEMU support"
          echo "For now, this validates the binary was built correctly"
          echo ""
          echo "To test on hardware:"
          echo "  espflash flash --monitor target/xtensa-esp32s3-espidf/release/esp32s3-parquet-test"
        continue-on-error: true

  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Run rustfmt
        run: |
          cargo fmt --all -- --check
        continue-on-error: true

      - name: Run clippy
        run: |
          cargo clippy --all-targets --all-features -- -D warnings
        continue-on-error: true

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, qemu-test, lint]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| QEMU Test | ${{ needs.qemu-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "✅ All checks completed" >> $GITHUB_STEP_SUMMARY

